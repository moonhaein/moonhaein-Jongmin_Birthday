<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê²Œì‹œê¸€ ë³´ê¸°</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <header>
    <div id="logo" onclick="location.href='index.html'">MyBoard Logo</div>
    <button id="login-btn">ë¡œê·¸ì¸</button>
  </header>

  <main>
    <div id="loading">ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    <div id="post-container" style="display: none;">
      <div id="post-content">
        <div id="post-header">
          <h1 id="post-title"></h1>
          <div id="post-meta"></div>
        </div>
        <div id="post-body"></div>
      </div>
      
      <div id="post-controls">
        <button onclick="location.href='index.html'">ëª©ë¡ìœ¼ë¡œ</button>
        <div id="author-controls"></div>
      </div>

      <div id="like-section">
        <button id="like-btn" class="like-btn">
          <span class="like-icon">ğŸ‘</span>
          <span id="like-count">0</span>
        </button>
        <button id="dislike-btn" class="like-btn">
          <span class="like-icon">ğŸ‘</span>
          <span id="dislike-count">0</span>
        </button>
      </div>

      <div id="comment-section">
        <h3>ëŒ“ê¸€</h3>
        <div id="comment-input-area">
          <textarea id="comment-input" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." rows="3"></textarea>
          <button id="comment-submit">ëŒ“ê¸€ ë“±ë¡</button>
        </div>
        <ul id="comment-list"></ul>
      </div>
    </div>
  </main>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, doc, getDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Firebase ì„¤ì • (ì˜¬ë°”ë¥¸ ì„¤ì •ìœ¼ë¡œ ìˆ˜ì •)
    const firebaseConfig = {
  apiKey: "AIzaSyAdkPdY2zegu26BS0q9LFVzNRemtu6WHgI",
  authDomain: "jominbirthday-82862.firebaseapp.com",
  projectId: "jominbirthday-82862",
  storageBucket: "jominbirthday-82862.firebasestorage.app",
  messagingSenderId: "109861443515",
  appId: "1:109861443515:web:008f42d07b241211a2569e",
  measurementId: "G-53L1BN0XFX"
};

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentPost = null;
    let postId = null;
    let currentUser = null;

    document.addEventListener('DOMContentLoaded', function() {
      // URLì—ì„œ ê²Œì‹œê¸€ ID ê°€ì ¸ì˜¤ê¸°
      const urlParams = new URLSearchParams(window.location.search);
      postId = urlParams.get('id');

      if (!postId) {
        alert('ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.');
        location.href = 'index.html';
        return;
      }

      currentUser = localStorage.getItem('username');
      updateLoginButton();
      loadPost();
      setupCommentSubmit();
      setupLikeButtons();
    });

    // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ë° ë²„íŠ¼ ì—…ë°ì´íŠ¸
    function updateLoginButton() {
      const loginBtn = document.getElementById('login-btn');
      const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
      
      if (isLoggedIn) {
        loginBtn.textContent = 'ë¡œê·¸ì•„ì›ƒ';
        loginBtn.onclick = logout;
      } else {
        loginBtn.textContent = 'ë¡œê·¸ì¸';
        loginBtn.onclick = () => location.href = 'login.html';
      }
    }

    function logout() {
      localStorage.removeItem('isLoggedIn');
      localStorage.removeItem('username');
      currentUser = null;
      updateLoginButton();
      location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ìƒíƒœ ê°±ì‹ 
    }

    // ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadPost() {
      try {
        const docRef = doc(db, 'posts', postId);
        const docSnap = await getDoc(docRef);

        if (!docSnap.exists()) {
          alert('ê²Œì‹œê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          location.href = 'index.html';
          return;
        }

        currentPost = { id: docSnap.id, ...docSnap.data() };
        
        // ì¡°íšŒìˆ˜ ì¦ê°€
        await updateDoc(docRef, {
          views: (currentPost.views || 0) + 1
        });

        displayPost();
        displayLikes();
        displayComments();
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('post-container').style.display = 'block';
      } catch (error) {
        console.error('ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:', error);
        alert('ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        location.href = 'index.html';
      }
    }

    // ê²Œì‹œê¸€ í‘œì‹œ
    function displayPost() {
      const title = document.getElementById('post-title');
      const meta = document.getElementById('post-meta');
      const body = document.getElementById('post-body');
      const authorControls = document.getElementById('author-controls');

      title.textContent = currentPost.title;
      
      const createdAt = currentPost.createdAt ? 
        new Date(currentPost.createdAt.seconds * 1000).toLocaleString('ko-KR') : 
        'ë‚ ì§œ ì—†ìŒ';
      
      meta.innerHTML = `
        <span>ì‘ì„±ì: ${currentPost.author}</span>
        <span>ì‘ì„±ì¼: ${createdAt}</span>
        <span>ì¡°íšŒìˆ˜: ${(currentPost.views || 0) + 1}</span>
      `;

      body.innerHTML = currentPost.content.replace(/\n/g, '<br>');

      // ì‘ì„±ìë§Œ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
      if (currentUser === currentPost.author) {
        authorControls.innerHTML = `
          <button onclick="editPost()">ìˆ˜ì •</button>
          <button onclick="deletePost()" class="delete-btn">ì‚­ì œ</button>
        `;
      }
    }

    // ì¢‹ì•„ìš”/ì‹«ì–´ìš” í‘œì‹œ
    function displayLikes() {
      const likeCount = document.getElementById('like-count');
      const dislikeCount = document.getElementById('dislike-count');
      const likeBtn = document.getElementById('like-btn');
      const dislikeBtn = document.getElementById('dislike-btn');

      const likes = currentPost.likes || [];
      const dislikes = currentPost.dislikes || [];

      likeCount.textContent = likes.length;
      dislikeCount.textContent = dislikes.length;

      // í˜„ì¬ ì‚¬ìš©ìì˜ ì¢‹ì•„ìš”/ì‹«ì–´ìš” ìƒíƒœ í‘œì‹œ
      if (currentUser) {
        const userLiked = likes.includes(currentUser);
        const userDisliked = dislikes.includes(currentUser);

        likeBtn.classList.toggle('active', userLiked);
        dislikeBtn.classList.toggle('active', userDisliked);
      } else {
        likeBtn.classList.remove('active');
        dislikeBtn.classList.remove('active');
      }

      // ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš° ë²„íŠ¼ ë¹„í™œì„±í™”
      const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
      likeBtn.disabled = !isLoggedIn;
      dislikeBtn.disabled = !isLoggedIn;

      if (!isLoggedIn) {
        likeBtn.title = 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤';
        dislikeBtn.title = 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤';
      } else {
        likeBtn.title = '';
        dislikeBtn.title = '';
      }
    }

    // ì¢‹ì•„ìš”/ì‹«ì–´ìš” ë²„íŠ¼ ì„¤ì •
    function setupLikeButtons() {
      const likeBtn = document.getElementById('like-btn');
      const dislikeBtn = document.getElementById('dislike-btn');

      likeBtn.addEventListener('click', () => handleLike(true));
      dislikeBtn.addEventListener('click', () => handleLike(false));
    }

    // ì¢‹ì•„ìš”/ì‹«ì–´ìš” ì²˜ë¦¬
    async function handleLike(isLike) {
      if (!currentUser) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
      }

      try {
        const docRef = doc(db, 'posts', postId);
        const likes = currentPost.likes || [];
        const dislikes = currentPost.dislikes || [];

        const userLiked = likes.includes(currentUser);
        const userDisliked = dislikes.includes(currentUser);

        let updateData = {};

        if (isLike) {
          // ì¢‹ì•„ìš” ë²„íŠ¼ í´ë¦­
          if (userLiked) {
            // ì´ë¯¸ ì¢‹ì•„ìš” ìƒíƒœë©´ ì¢‹ì•„ìš” ì·¨ì†Œ
            updateData.likes = arrayRemove(currentUser);
          } else {
            // ì¢‹ì•„ìš” ì¶”ê°€
            updateData.likes = arrayUnion(currentUser);
            // ì‹«ì–´ìš”ê°€ ìˆë‹¤ë©´ ì œê±°
            if (userDisliked) {
              updateData.dislikes = arrayRemove(currentUser);
            }
          }
        } else {
          // ì‹«ì–´ìš” ë²„íŠ¼ í´ë¦­
          if (userDisliked) {
            // ì´ë¯¸ ì‹«ì–´ìš” ìƒíƒœë©´ ì‹«ì–´ìš” ì·¨ì†Œ
            updateData.dislikes = arrayRemove(currentUser);
          } else {
            // ì‹«ì–´ìš” ì¶”ê°€
            updateData.dislikes = arrayUnion(currentUser);
            // ì¢‹ì•„ìš”ê°€ ìˆë‹¤ë©´ ì œê±°
            if (userLiked) {
              updateData.likes = arrayRemove(currentUser);
            }
          }
        }

        await updateDoc(docRef, updateData);

        // ê²Œì‹œê¸€ ë°ì´í„° ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
        const updatedDocSnap = await getDoc(docRef);
        currentPost = { id: updatedDocSnap.id, ...updatedDocSnap.data() };
        displayLikes();

      } catch (error) {
        console.error('ì¢‹ì•„ìš”/ì‹«ì–´ìš” ì²˜ë¦¬ ì‹¤íŒ¨:', error);
        alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ëŒ“ê¸€ í‘œì‹œ
    function displayComments() {
      const commentList = document.getElementById('comment-list');
      const comments = currentPost.comments || [];
      
      if (comments.length === 0) {
        commentList.innerHTML = '<li class="no-comments">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
        return;
      }

      commentList.innerHTML = '';
      comments.forEach((comment, index) => {
        const li = document.createElement('li');
        li.className = 'comment-item';
        
        const commentDate = comment.createdAt ? 
          new Date(comment.createdAt.seconds * 1000).toLocaleString('ko-KR') : 
          'ë‚ ì§œ ì—†ìŒ';
        
        li.innerHTML = `
          <div class="comment-author">${comment.author}</div>
          <div class="comment-content">${comment.content.replace(/\n/g, '<br>')}</div>
          <div class="comment-date">${commentDate}</div>
        `;
        
        commentList.appendChild(li);
      });
    }

    // ëŒ“ê¸€ ì œì¶œ ì„¤ì •
    function setupCommentSubmit() {
      const commentInput = document.getElementById('comment-input');
      const commentSubmit = document.getElementById('comment-submit');
      const commentInputArea = document.getElementById('comment-input-area');

      // ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ ëŒ“ê¸€ ì…ë ¥ë€ í‘œì‹œ/ìˆ¨ê¹€
      const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
      if (!isLoggedIn) {
        commentInputArea.style.display = 'none';
        return;
      }

      commentSubmit.addEventListener('click', submitComment);
      
      commentInput.addEventListener('keypress', function(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
          event.preventDefault();
          submitComment();
        }
      });
    }

    // ëŒ“ê¸€ ì œì¶œ
    async function submitComment() {
      const commentInput = document.getElementById('comment-input');
      const commentSubmit = document.getElementById('comment-submit');
      const content = commentInput.value.trim();
      
      if (!content) {
        alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      const username = localStorage.getItem('username');
      if (!username) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
      }

      commentSubmit.disabled = true;
      commentSubmit.textContent = 'ë“±ë¡ ì¤‘...';

      try {
        const docRef = doc(db, 'posts', postId);
        const newComment = {
          author: username,
          content: content,
          createdAt: serverTimestamp()
        };

        await updateDoc(docRef, {
          comments: arrayUnion(newComment)
        });

        commentInput.value = '';
        
        // ê²Œì‹œê¸€ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
        await loadPost();
        
        alert('ëŒ“ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
      } catch (error) {
        console.error('ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨:', error);
        alert('ëŒ“ê¸€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      } finally {
        commentSubmit.disabled = false;
        commentSubmit.textContent = 'ëŒ“ê¸€ ë“±ë¡';
      }
    }

    // ê²Œì‹œê¸€ ìˆ˜ì •
    window.editPost = function() {
      location.href = `edit.html?id=${postId}`;
    };

    // ê²Œì‹œê¸€ ì‚­ì œ
    window.deletePost = async function() {
      if (!confirm('ì •ë§ë¡œ ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }

      try {
        await deleteDoc(doc(db, 'posts', postId));
        alert('ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        location.href = 'index.html';
      } catch (error) {
        console.error('ê²Œì‹œê¸€ ì‚­ì œ ì‹¤íŒ¨:', error);
        alert('ê²Œì‹œê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    };
  </script>
</body>
</html>